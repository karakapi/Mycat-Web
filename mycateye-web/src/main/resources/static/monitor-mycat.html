<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mycat 性能监控</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Responsive Website Template">

    <link href="assets/css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="assets/css/elegant-icons.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" media="all" href="assets/css/daterangepicker-bs3.css" />
    <link rel="stylesheet" href="assets/css/jquery.mloading.css" />
    <link rel="stylesheet" href="assets/css/jquery.dataTables.min.css">
    <link href="assets/css/main.css" rel="stylesheet" type="text/css">
    <link href="assets/css/my-custom-styles.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div id="wrapper">
        <!-- 导航 -->
        <nav class="navbar navbar-default navbar-fixed-top ">
            <div class="container">
                <a href="index.html" class="navbar-brand">
                    <img src="assets/img/logo/logo_80.png" style="width: 80px; height: 46px;">
                </a>
                <div id="main-nav-collapse" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav main-navbar-nav">
                        <li class="dropdown">
                            <a href="index.html" class="dropdown-toggle" data-toggle="dropdown">首页</a>
                        </li>
                        <li class="dropdown">
                            <a href="mysql-mycnf.html" class="dropdown-toggle" data-toggle="dropdown">my.cnf生成工具</a>
                        </li>
                        <li class="dropdown ">
                            <a href="mysql-cluster.html" class="dropdown-toggle" data-toggle="dropdown">集群管理</a>
                        </li>
                        <!--<li class="dropdown">-->
                            <!--<a href="mysql-performance-monitor.html" class="dropdown-toggle" data-toggle="dropdown">性能监控</a>-->
                        <!--</li>-->
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                Mycat监控 <i class="fa fa-angle-down"></i>
                            </a>
                            <ul class="dropdown-menu" role="menu">
                                <li class="active"><a href="monitor-mycat.html">服务监控</a></li>
                                <li><a href="monitor-mycat-sql-execute.html">SQL执行情况</a></li>
                                <li><a href="monitor-mycat-sql.html">SQL性能监控</a></li>
                                <li><a href="monitor-mycat-datanode.html">数据节点</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                Mysql监控 <i class="fa fa-angle-down"></i>
                            </a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="mysql-sql-monitor.html">SQL监控</a></li>
                                <li><a href="mysql-slow-monitor.html">慢查询SQL</a></li>
                                <li><a href="mysql-performance-monitor.html">性能监控</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="mysql-health-check.html" class="dropdown-toggle" data-toggle="dropdown">健康检查</a>
                        </li>
                        <li class="dropdown">
                            <a target="_blank" href="admin/index.html" class="dropdown-toggle" data-toggle="dropdown">控制台</a>
                        </li>
                        <li class="dropdown">
                            <div class="btn-group" style="margin-top: 18px; margin-left: 40px;">
                                <button type="button" class="btn btn-default" id="defaultNode">选择节点</button>
                                <button type="button" class="btn btn-default dropdown-toggle"
                                        data-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false">
                                    <span class="caret"></span>
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu" id="nodeUl">
                                </ul>
                            </div>
                            <input type="hidden" id="defaultServerId" value="" />
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- END 导航 -->

        <!-- 内容 -->
        <section>
            <div class="container">
                <ol class="breadcrumb" style="font-size: 14px;">
                    <li><a href="index.html">首页</a></li>
                    <li>Mycat 监控</li>
                    <li class="active">Mycat 服务监控</li>
                </ol>
            </div>

            <div class="container">
                <form id="searchForm" class="form-inline bg-light form-toptool mb-1">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>
                                <i class="fa fa-calendar"></i> 查询时间：
                            </label>
                            <span>
                                <input type="text" style="width: 320px;" name="reservation"
                                               id="reservationtime" class="form-control"
                                               value="2017/08/01 1:00:00 - 2017/08/02 13:30:00"
                                               class="span4" />
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <span>
                                <i class="fa fa-cube"></i> 节点：
                            </span>
                            <select id="dataNodes" class="form-control">
                                <option value="1">9066</option>
                                <option value="2">9067</option>
                            </select>
                            <button type="button" class="btn btn-success" id="btn-search">查询</button>
                        </div>
                    </div>
                </div>
                </form>
            </div>

            <div class="container">
                <ul class="nav nav-tabs bg-light radius3" role="tablist" id="monitor-mycat-tab">
                    <li role="presentation" class="active">
                        <a href="#mm-memory" aria-controls="mm-memory" role="tab" data-toggle="tab" data-action="showMemory">Mycat 内存分析</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="mm-memory">
                        <div id="mycat-memory" class="mycat-chart"></div>
                    </div>
                </div>
            </div>

            <div class="container" style="margin-top:20px;">
                <ul class="nav nav-tabs bg-light radius3" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#mm-connection" aria-controls="mm-connection" role="tab" data-toggle="tab" data-action="showConnection">Mycat 前端连接</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="mm-connection">
                        <!--<div id="mycat-connection" class="mycat-chart"></div>-->
                        <div class="mycat-chart" style="width:100%;overflow: auto;padding:20px 0px;">
                            <table id="mycat-connection" class="display mydatatable" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>PROCESSOR</th>
                                        <th>HOST</th>
                                        <th>PORT</th>
                                        <th>LOCAL_PORT</th>
                                        <!--<th>USER</th>-->
                                        <!--<th>CHARSET</th>-->
                                        <th>NET_IN</th>
                                        <th>NET_OUT</th>
                                        <!--<th>SCHEMA</th>-->
                                        <th>ALIVE_TIME(S)</th>
                                        <th>RECV_BUFFER</th>
                                        <th>SEND_QUEUE</th>
                                        <th>txlevel</th>
                                        <th>autocommit</th>
                                        <!-- <th>操作</th> -->
                                    </tr>
                                </thead>
            
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container" style="margin-top:20px;">
                <ul class="nav nav-tabs bg-light radius3" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#mm-backend" aria-controls="mm-backend" role="tab" data-toggle="tab" data-action="showBackend">Mycat 后端连接</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="mm-backend">
                        <!--<div id="mycat-backend" class="mycat-chart"></div>-->
                        <div class="mycat-chart" style="width:100%;overflow: auto;padding:20px 0px;">
                            <table id="mycat-backend" class="display mydatatable" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>processor</th>
                                        <th>mysqlId</th>
                                        <th>host</th>
                                        <th>port</th>
                                        <th>l_port</th>
                                        <th>net_in</th>
                                        <th>net_out</th>
                                        <th>life</th>
                                        <th>closed</th>
                                        <th>borrowed</th>
                                        <th>SEND_QUEUE</th>
                                        <th>schema</th>
                                        <!--<th>charset</th>-->
                                        <th>txlevel</th>
                                        <th>autocommit</th>
                                    </tr>
                                </thead>
            
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- END 内容 -->

        <!-- 页脚 -->
        <footer class="footer-newsletter">
            <div class="container">

                <div class="footer-bottom">
                    <div class="left">

                        <p class="copyright-text">&copy;2017 MyCAT EYE</p>
                    </div>

                </div>
            </div>
        </footer>
        <!-- END 页脚 -->
    </div>

    <div class="fakeloader"></div>
    <!-- JAVASCRIPT -->
    <script src="assets/js/jquery-2.1.1.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/plugins/easing/jquery.easing.min.js"></script>
    <script src="assets/js/plugins/morphext/morphext.min.js"></script>
    <script src="assets/js/plugins/owl-carousel/owl.carousel.min.js"></script>
    <script src="assets/js/bravana-lite.js"></script>
    <script src="assets/js/echarts.common.min.js"></script>
    <!-- DataTables -->
    <script src="assets/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap.min.js"></script>
    <!-- 时间区间组件 -->
    <script type="text/javascript" src="assets/js/moment.js"></script>
    <script type="text/javascript" src="assets/js/daterangepicker.js"></script>
    <!-- loading效果 -->
    <script src="assets/js/jquery.mloading.js"></script>
    <!-- 置顶悬浮图标 -->
    <div class="float-container float"><a href="javascript:$(window).scrollTop(0, 0);"><img src="assets/img/top.gif" style="border:0px;" /></a></div>

    <!-- 自定义JAVASCRIPT -->
    <script src="assets/js/misc-util.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/monitor/mycat.js"></script>
    <script>
        $(function () {
            //初始化时间区间
            var datetimerange = $("#reservationtime");
            if (datetimerange && datetimerange.size() > 0) {
                var now = getMillisecondAgoFormatDate(0);
                var halfAnHourAgo = getMillisecondAgoFormatDate(30 * 60 * 1000);
                var timeRange = halfAnHourAgo + " - " + now;
                datetimerange.val(timeRange);
                //定义时间选择事件
                datetimerange.daterangepicker({
                        timePicker: true,
                        timePickerIncrement: 1,
                        format: 'YYYY/MM/DD HH:mm:ss'
                    },
                    function (start, end, label) {
                        var tr = datetimerange.val();
                        console.log('start', start, 'end', end, 'label', label);
                        //$('#timeRange').val(tr);
                    });
            }
            
            $('#btn-search').on('click', function(e){
                var action = $('#monitor-mycat-tab').find('.active').find('a').attr('data-action');
                //mycatEye[action] && typeof (mycatEye[action] == 'function') ? mycatEye[action]() : null;
                doSearch();
            });
            
            doSearch();

            function doSearch(){
                var sid = $('#dataNodes').val();
                var tr = $('#reservationtime').val();
                showMemory(sid,tr);
                showConnection(sid,tr);
                showBackend(sid,tr);
            }
            function showMemory() {
                return mycatEye.showMemory();
            }
            var tb1,tb2
            function showConnection() {
                var sid = $('#dataNodes').val();
                var tr = $("#reservationtime").val();
                if(tb1){
                    tb1.destroy();
                }
                tb1 = $('#mycat-connection').DataTable({
                    'ajax': '/mycat/server/connection?server_id=' + sid + '&timeRange=' + tr,
                    'columns':[
                        { 'data':'id'},
                        { 'data':'processor'},
                        { 'data':'cHost'},
                        { 'data':'cPort'},
                        { 'data':'lPort'},
                        { 'data':'netIn'},
                        { 'data':'netOut'},
                        { 'data':'aliveTime'},
                        { 'data':'recvBuffer'},
                        { 'data':'sendQueue'},
                        { 'data':'txlevel'},
                        { 'data':'autocommit'}
                    ]
                });
            }
            function showBackend() {
                var sid = $('#dataNodes').val();
                var tr = $("#reservationtime").val();
                if (tb2) {
                    tb2.destroy();
                }
                tb2 = $('#mycat-backend').DataTable({
                    'ajax': '/mycat/server/backend?server_id=' + sid + '&timeRange=' + tr,
                    'columns': [
                        { 'data': 'id' },
                        { 'data': 'processor' },
                        { 'data': 'mysqlid' },
                        { 'data': 'cHost' },
                        { 'data': 'cPort' },
                        { 'data': 'lPort' },
                        { 'data': 'netIn' },
                        { 'data': 'netOut' },
                        { 'data': 'life' },
                        { 'data': 'closed' },
                        { 'data': 'borrowed' },
                        { 'data': 'sendQueue' },
                        { 'data': 'cSchema' },
                        { 'data': 'txlevel' },
                        { 'data': 'autocommit' }
                    ]
                });
            }

            $('#monitor-mycat-tab').find('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
//                console.log(e.target);//current
//                console.log(e.relatedTarget);//prev
                var action = $(e.target).attr('data-action');
                console.log(action);
                //mycatEye[action] && typeof(mycatEye[action] == 'function')?mycatEye[action]():null;
            });

        });
    </script>
</body>
</html>